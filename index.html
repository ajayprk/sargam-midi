<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sargam MIDI Monitor</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background: #fdfdfd; padding: 20px; color: #333; }
        #display { font-size: 5rem; margin: 20px; font-weight: bold; color: #d35400; min-height: 1.5em; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .controls { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: inline-block; margin-bottom: 30px; }
        .control-group { margin: 15px 0; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        select, button { padding: 8px 12px; font-size: 1rem; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }
        button { background-color: #27ae60; color: white; border: none; font-weight: bold; width: 100%; }
        button:hover { background-color: #2ecc71; }
        label { font-weight: 600; font-size: 0.9rem; }
        
        #keyboard { display: flex; justify-content: center; margin-top: 50px; padding-bottom: 50px; overflow-x: auto; }
        .key { border: 1px solid #999; height: 160px; width: 45px; background: white; box-sizing: border-box; flex-shrink: 0; border-radius: 0 0 4px 4px; position: relative; }
        .key.black { background: #222; height: 100px; width: 32px; margin-left: -16px; margin-right: -16px; z-index: 2; border-radius: 0 0 3px 3px; }
        .key.active { background: #e67e22 !important; box-shadow: inset 0 -5px 10px rgba(0,0,0,0.2); transform: translateY(2px); }
    </style>
</head>
<body>

    <h1>Sargam MIDI Monitor</h1>

    <div class="controls">
        <button id="initBtn">1. Initialize MIDI</button>
        
        <div class="control-group">
            <label for="midiIn">Device:</label>
            <select id="midiIn"><option value="">-- Connect MIDI --</option></select>
        </div>

        <div class="control-group">
            <label for="tonic">Tonic (Sa):</label>
            <select id="tonic">
                <option value="0">C</option><option value="1">C#</option><option value="2">D</option>
                <option value="3">D#</option><option value="4">E</option><option value="5">F</option>
                <option value="6">F#</option><option value="7">G</option><option value="8">G#</option>
                <option value="9">A</option><option value="10">A#</option><option value="11">B</option>
            </select>
        </div>

        <div class="control-group">
            <label for="transpose">Transpose:</label>
            <select id="transpose">
                <option value="-12">-12</option><option value="-7">-7</option>
                <option value="-2">-2</option><option value="-1">-1</option>
                <option value="0" selected>0 (None)</option>
                <option value="1">+1</option><option value="2">+2</option>
                <option value="7">+7</option><option value="12">+12</option>
            </select>
        </div>
    </div>

    <div id="display">Awaiting MIDI...</div>

    <div id="keyboard"></div>

    <script>
        const sargamNotes = ["Sa", "re", "Re", "ga", "Ga", "Ma", "ma", "Pa", "dha", "Dha", "ni", "Ni"];
        const tonicSelect = document.getElementById('tonic');
        const transposeSelect = document.getElementById('transpose');
        const midiSelect = document.getElementById('midiIn');
        const initBtn = document.getElementById('initBtn');
        const display = document.getElementById('display');
        const keyboard = document.getElementById('keyboard');

        const startNote = 48; 
        const totalNotes = 37; 
        const keys = {};
        let currentInput = null;

        function buildKeyboard() {
            keyboard.innerHTML = '';
            for (let i = 0; i < totalNotes; i++) {
                const midiNote = startNote + i;
                const isBlack = [1, 3, 6, 8, 10].includes(midiNote % 12);
                const keyDiv = document.createElement('div');
                keyDiv.className = `key ${isBlack ? 'black' : 'white'}`;
                keyboard.appendChild(keyDiv);
                keys[midiNote] = keyDiv;
            }
        }

        function handleMidiMessage(message) {
            const [command, rawNote, velocity] = message.data;
            const type = command & 0xf0; 

            // Apply Transpose
            const note = rawNote + parseInt(transposeSelect.value);

            if (type === 144 && velocity > 0) { 
                const tonic = parseInt(tonicSelect.value);
                const normalizedNote = ((note - tonic) % 12 + 12) % 12;
                display.innerText = sargamNotes[normalizedNote];
                if (keys[note]) keys[note].classList.add('active');
            } else if (type === 128 || (type === 144 && velocity === 0)) { 
                if (keys[note]) keys[note].classList.remove('active');
            }
        }

        async function initMIDI() {
            if (!navigator.requestMIDIAccess) return alert("Browser not supported.");
            try {
                const midiAccess = await navigator.requestMIDIAccess();
                initBtn.innerText = "MIDI Initialized";
                initBtn.disabled = true;

                const updateInputs = () => {
                    const inputs = midiAccess.inputs.values();
                    midiSelect.innerHTML = '<option value="">-- Choose Device --</option>';
                    for (let input of inputs) {
                        const opt = document.createElement('option');
                        opt.value = input.id;
                        opt.text = input.name;
                        midiSelect.add(opt);
                    }
                };

                midiAccess.onstatechange = updateInputs;
                updateInputs();

                midiSelect.onchange = () => {
                    if (currentInput) currentInput.onmidimessage = null;
                    currentInput = midiAccess.inputs.get(midiSelect.value);
                    if (currentInput) {
                        currentInput.onmidimessage = handleMidiMessage;
                        display.innerText = "Ready!";
                    }
                };
            } catch (err) { console.error(err); }
        }

        initBtn.addEventListener('click', initMIDI);
        buildKeyboard();
    </script>
</body>
</html>
