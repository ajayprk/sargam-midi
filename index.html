<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sargam MIDI Monitor</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background: #fdfdfd; padding: 20px; color: #333; }
        
        /* Sargam Display */
        #display { font-size: 7rem; margin: 10px; font-weight: bold; color: #d35400; min-height: 1.5em; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        #status-bar { font-size: 1rem; color: #7f8c8d; margin-bottom: 20px; font-weight: 600; }

        /* Collapsible Settings Box */
        .settings-container { background: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: inline-block; margin-bottom: 20px; overflow: hidden; transition: all 0.3s ease; text-align: left; width: 320px; }
        .settings-header { background: #f8f9fa; padding: 10px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .settings-header h3 { margin: 0; font-size: 1rem; color: #2c3e50; }
        .settings-content { padding: 15px; }
        .settings-container.minimized .settings-content { display: none; }
        .settings-container.minimized { width: 180px; }

        .control-group { margin: 12px 0; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        select, button { padding: 8px 12px; font-size: 0.95rem; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }
        #initBtn { background-color: #27ae60; color: white; border: none; font-weight: bold; width: 100%; margin-bottom: 10px; }
        label { font-weight: 600; font-size: 0.9rem; }

        /* Keyboard */
        #keyboard { display: flex; justify-content: center; margin-top: 40px; padding-bottom: 50px; overflow-x: auto; }
        .key { border: 1px solid #999; height: 160px; width: 45px; background: white; box-sizing: border-box; flex-shrink: 0; border-radius: 0 0 4px 4px; position: relative; }
        .key.black { background: #222; height: 100px; width: 32px; margin-left: -16px; margin-right: -16px; z-index: 2; border-radius: 0 0 3px 3px; }
        .key.active { background: #e67e22 !important; box-shadow: inset 0 -5px 10px rgba(0,0,0,0.2); transform: translateY(2px); }
    </style>
</head>
<body>

    <h1>Sargam MIDI Monitor</h1>

    <div id="status-bar">Transpose: 0</div>

    <div class="settings-container" id="settingsBox">
        <div class="settings-header" onclick="toggleSettings()">
            <h3>Settings</h3>
            <span id="toggleIcon">−</span>
        </div>
        <div class="settings-content">
            <button id="initBtn">1. Initialize MIDI</button>
            
            <div class="control-group">
                <label for="midiIn">Device:</label>
                <select id="midiIn"><option value="">-- Connect MIDI --</option></select>
            </div>

            <div class="control-group">
                <label for="transpose">Transpose (Shift Sa):</label>
                <select id="transpose" onchange="updateStatusText()"></select>
            </div>
        </div>
    </div>

    <div id="display">Awaiting MIDI...</div>

    <div id="keyboard"></div>

    <script>
        const sargamNotes = ["Sa", "re", "Re", "ga", "Ga", "Ma", "ma", "Pa", "dha", "Dha", "ni", "Ni"];
        const transposeSelect = document.getElementById('transpose');
        const midiSelect = document.getElementById('midiIn');
        const initBtn = document.getElementById('initBtn');
        const display = document.getElementById('display');
        const keyboard = document.getElementById('keyboard');
        const statusBar = document.getElementById('status-bar');
        const settingsBox = document.getElementById('settingsBox');
        const toggleIcon = document.getElementById('toggleIcon');

        const startNote = 48; // C3
        const totalNotes = 37; 
        const keys = {};
        let currentInput = null;

        function toggleSettings() {
            settingsBox.classList.toggle('minimized');
            toggleIcon.innerText = settingsBox.classList.contains('minimized') ? "+" : "−";
        }

        function updateStatusText() {
            const transVal = transposeSelect.value;
            statusBar.innerText = `Transpose: ${transVal > 0 ? '+' : ''}${transVal}`;
        }

        function initTransposeOptions() {
            for (let i = -12; i <= 12; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = i === 0 ? "0 (Sa = C)" : (i > 0 ? `+${i}` : i);
                if (i === 0) opt.selected = true;
                transposeSelect.add(opt);
            }
        }

        function buildKeyboard() {
            keyboard.innerHTML = '';
            for (let i = 0; i < totalNotes; i++) {
                const midiNote = startNote + i;
                const isBlack = [1, 3, 6, 8, 10].includes(midiNote % 12);
                const keyDiv = document.createElement('div');
                keyDiv.className = `key ${isBlack ? 'black' : 'white'}`;
                keyboard.appendChild(keyDiv);
                keys[midiNote] = keyDiv;
            }
        }

        function handleMidiMessage(message) {
            const [command, rawNote, velocity] = message.data;
            const type = command & 0xf0; 
            
            // Apply Transpose directly to the note used for calculation and display
            const transposedNote = rawNote + parseInt(transposeSelect.value);

            if (type === 144 && velocity > 0) { 
                // Always calculate Sargam relative to C (0) after transpose is applied
                const normalizedNote = (transposedNote % 12 + 12) % 12;
                display.innerText = sargamNotes[normalizedNote];
                
                // Highlight the actual key pressed on the keyboard
                if (keys[rawNote]) keys[rawNote].classList.add('active');
            } else if (type === 128 || (type === 144 && velocity === 0)) { 
                if (keys[rawNote]) keys[rawNote].classList.remove('active');
            }
        }

        async function initMIDI() {
            if (!navigator.requestMIDIAccess) return alert("Browser not supported.");
            try {
                const midiAccess = await navigator.requestMIDIAccess();
                initBtn.innerText = "MIDI Connected";
                initBtn.style.backgroundColor = "#bdc3c7";
                initBtn.disabled = true;

                const updateInputs = () => {
                    const inputs = midiAccess.inputs.values();
                    midiSelect.innerHTML = '<option value="">-- Choose Device --</option>';
                    for (let input of inputs) {
                        const opt = document.createElement('option');
                        opt.value = input.id;
                        opt.text = input.name;
                        midiSelect.add(opt);
                    }
                };

                midiAccess.onstatechange = updateInputs;
                updateInputs();

                midiSelect.onchange = () => {
                    if (currentInput) currentInput.onmidimessage = null;
                    currentInput = midiAccess.inputs.get(midiSelect.value);
                    if (currentInput) {
                        currentInput.onmidimessage = handleMidiMessage;
                        display.innerText = "Ready!";
                        setTimeout(toggleSettings, 500);
                    }
                };
            } catch (err) { console.error(err); }
        }

        initBtn.addEventListener('click', initMIDI);
        initTransposeOptions();
        buildKeyboard();
        updateStatusText();
    </script>
</body>
</html>
