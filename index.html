<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI Hindi Sargam Visualizer</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f4f4f4; padding: 20px; }
        #display { font-size: 3rem; margin: 20px; font-weight: bold; color: #2c3e50; min-height: 1.2em; }
        .controls { margin-bottom: 30px; }
        
        /* Keyboard Styling */
        #keyboard { display: flex; justify-content: center; margin-top: 50px; position: relative; }
        .key { border: 1px solid #555; height: 150px; width: 40px; background: white; cursor: pointer; display: inline-block; position: relative; z-index: 1; }
        .key.black { background: #333; height: 100px; width: 30px; margin-left: -15px; margin-right: -15px; z-index: 2; }
        .key.active { background: #e74c3c !important; }
    </style>
</head>
<body>

    <h1>Sargam MIDI Monitor</h1>

    <div class="controls">
        <label for="tonic">Select Tonic (Sa): </label>
        <select id="tonic">
            <option value="0">C</option>
            <option value="1">C# / Db</option>
            <option value="2">D</option>
            <option value="3">D# / Eb</option>
            <option value="4">E</option>
            <option value="5">F</option>
            <option value="6">F# / Gb</option>
            <option value="7">G</option>
            <option value="8">G# / Ab</option>
            <option value="9">A</option>
            <option value="10">A# / Bb</option>
            <option value="11">B</option>
        </select>
    </div>

    <div id="display">Press a key...</div>

    <div id="keyboard"></div>

    <script>
        const sargamNotes = ["Sa", "re", "Re", "ga", "Ga", "Ma", "ma", "Pa", "dha", "Dha", "ni", "Ni"];
        const tonicSelect = document.getElementById('tonic');
        const display = document.getElementById('display');
        const keyboard = document.getElementById('keyboard');

        // Create 3 Octaves (36 notes starting from C3 - MIDI 48)
        const startNote = 48;
        const totalNotes = 36;
        const keys = {};

        function buildKeyboard() {
            for (let i = 0; i < totalNotes; i++) {
                const midiNote = startNote + i;
                const isBlack = [1, 3, 6, 8, 10].includes(midiNote % 12);
                const keyDiv = document.createElement('div');
                keyDiv.className = `key ${isBlack ? 'black' : 'white'}`;
                keyDiv.dataset.note = midiNote;
                keyboard.appendChild(keyDiv);
                keys[midiNote] = keyDiv;
            }
        }

        function updateDisplay(midiNote, velocity) {
            if (velocity > 0) {
                const tonic = parseInt(tonicSelect.value);
                const relativeNote = (midiNote - tonic) % 12;
                // Handle negative modulo for notes below tonic
                const normalizedNote = (relativeNote + 12) % 12;
                
                display.innerText = sargamNotes[normalizedNote];
                if (keys[midiNote]) keys[midiNote].classList.add('active');
            } else {
                if (keys[midiNote]) keys[midiNote].classList.remove('active');
            }
        }

        // MIDI Access
        if (navigator.requestMIDIAccess) {
            navigator.requestMIDIAccess().then(onMIDISuccess, () => console.log("MIDI Access Denied"));
        }

        function onMIDISuccess(midiAccess) {
            for (let input of midiAccess.inputs.values()) {
                input.onmidimessage = (message) => {
                    const [command, note, velocity] = message.data;
                    if (command === 144 || command === 128) { // Note On or Note Off
                        updateDisplay(note, command === 144 ? velocity : 0);
                    }
                };
            }
        }

        buildKeyboard();
    </script>
</body>
</html>
