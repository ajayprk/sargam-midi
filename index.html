<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sargam MIDI Monitor</title>
    <style>
        :root { --bg-color: #fdfdfd; --fg-color: #d35400; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background: var(--bg-color); padding: 20px; color: #333; transition: background 0.3s ease; }
        
        #display { font-size: 7rem; margin: 10px; font-weight: bold; color: var(--fg-color); min-height: 1.5em; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        #status-bar { font-size: 1rem; color: #7f8c8d; margin-bottom: 20px; font-weight: 600; }

        .settings-container { background: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: inline-block; margin-bottom: 20px; overflow: hidden; transition: all 0.3s ease; text-align: left; width: 340px; color: #333; }
        .settings-header { background: #f8f9fa; padding: 10px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .settings-header h3 { margin: 0; font-size: 1rem; color: #2c3e50; }
        .settings-content { padding: 15px; }
        .settings-container.minimized .settings-content { display: none; }
        .settings-container.minimized { width: 180px; }

        .control-group { margin: 12px 0; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        select, button, input[type="color"] { padding: 8px; font-size: 0.95rem; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }
        #initBtn { background-color: #27ae60; color: white; border: none; font-weight: bold; width: 100%; margin-bottom: 10px; }
        label { font-weight: 600; font-size: 0.9rem; }

        #keyboard { display: flex; justify-content: center; margin-top: 40px; padding-bottom: 50px; overflow-x: auto; }
        .key { border: 1px solid #999; height: 160px; width: 45px; background: white; box-sizing: border-box; flex-shrink: 0; border-radius: 0 0 4px 4px; position: relative; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 10px; font-size: 0.8rem; font-weight: bold; color: #666; }
        .key.black { background: #222; height: 100px; width: 32px; margin-left: -16px; margin-right: -16px; z-index: 2; border-radius: 0 0 3px 3px; color: #fff; padding-bottom: 5px; font-size: 0.7rem; }
        .key.active { background: var(--fg-color) !important; color: white; box-shadow: inset 0 -5px 10px rgba(0,0,0,0.2); transform: translateY(2px); }
    </style>
</head>
<body>

    <h1 id="title">Sargam MIDI Monitor</h1>

    <div id="status-bar">Transpose: 0</div>

    <div class="settings-container" id="settingsBox">
        <div class="settings-header" onclick="toggleSettings()">
            <h3>Settings</h3>
            <span id="toggleIcon">−</span>
        </div>
        <div class="settings-content">
            <button id="initBtn">1. Initialize MIDI</button>
            <div class="control-group">
                <label for="midiIn">Device:</label>
                <select id="midiIn"><option value="">-- Connect MIDI --</option></select>
            </div>
            <div class="control-group">
                <label for="transpose">Transpose (Shift Sa):</label>
                <select id="transpose"></select>
            </div>
            <div class="control-group">
                <label>Background:</label>
                <input type="color" id="bgColor" value="#fdfdfd">
            </div>
            <div class="control-group">
                <label>Swar Color:</label>
                <input type="color" id="fgColor" value="#d35400">
            </div>
        </div>
    </div>

    <div id="display">Awaiting MIDI...</div>

    <div id="keyboard"></div>

    <script>
        const sargamNotes = ["Sa", "re", "Re", "ga", "Ga", "ma", "Ma", "Pa", "dha", "Dha", "ni", "Ni"];
        
        const transposeSelect = document.getElementById('transpose');
        const midiSelect = document.getElementById('midiIn');
        const initBtn = document.getElementById('initBtn');
        const display = document.getElementById('display');
        const keyboard = document.getElementById('keyboard');
        const statusBar = document.getElementById('status-bar');
        const settingsBox = document.getElementById('settingsBox');
        const toggleIcon = document.getElementById('toggleIcon');
        const bgColorInput = document.getElementById('bgColor');
        const fgColorInput = document.getElementById('fgColor');

        const startNote = 48; // C3
        const totalNotes = 37; 
        const keys = {};
        let currentInput = null;

        // --- Persistence Helpers ---
        function saveSettings() {
            const settings = {
                transpose: transposeSelect.value,
                deviceId: midiSelect.value,
                bg: bgColorInput.value,
                fg: fgColorInput.value
            };
            localStorage.setItem('sargamSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('sargamSettings');
            if (saved) {
                const s = JSON.parse(saved);
                transposeSelect.value = s.transpose || 0;
                bgColorInput.value = s.bg || "#fdfdfd";
                fgColorInput.value = s.fg || "#d35400";
                applyColors();
                updateStatusText();
                return s.deviceId;
            }
            return null;
        }

        function applyColors() {
            document.documentElement.style.setProperty('--bg-color', bgColorInput.value);
            document.documentElement.style.setProperty('--fg-color', fgColorInput.value);
        }

        function toggleSettings() {
            settingsBox.classList.toggle('minimized');
            toggleIcon.innerText = settingsBox.classList.contains('minimized') ? "+" : "−";
        }

        function updateStatusText() {
            const transVal = transposeSelect.value;
            statusBar.innerText = `Transpose: ${transVal > 0 ? '+' : ''}${transVal}`;
            buildKeyboard(); // Refresh labels when transpose changes
            saveSettings();
        }

        function initTransposeOptions() {
            for (let i = -12; i <= 12; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = i === 0 ? "0 (Sa = C)" : (i > 0 ? `+${i}` : i);
                transposeSelect.add(opt);
            }
        }

        function buildKeyboard() {
            keyboard.innerHTML = '';
            const transposeVal = parseInt(transposeSelect.value) || 0;
            
            for (let i = 0; i < totalNotes; i++) {
                const midiNote = startNote + i;
                const isBlack = [1, 3, 6, 8, 10].includes(midiNote % 12);
                
                // Calculate Swar Label based on Transpose
                const transposedNote = midiNote + transposeVal;
                const sargamIndex = (transposedNote % 12 + 12) % 12;
                const label = sargamNotes[sargamIndex];

                const keyDiv = document.createElement('div');
                keyDiv.className = `key ${isBlack ? 'black' : 'white'}`;
                keyDiv.innerText = label;
                keyboard.appendChild(keyDiv);
                keys[midiNote] = keyDiv;
            }
        }

        function handleMidiMessage(message) {
            const [command, rawNote, velocity] = message.data;
            const type = command & 0xf0; 
            const transposedNote = rawNote + parseInt(transposeSelect.value);

            if (type === 144 && velocity > 0) { 
                const normalizedNote = (transposedNote % 12 + 12) % 12;
                display.innerText = sargamNotes[normalizedNote];
                if (keys[rawNote]) keys[rawNote].classList.add('active');
            } else if (type === 128 || (type === 144 && velocity === 0)) { 
                if (keys[rawNote]) keys[rawNote].classList.remove('active');
            }
        }

        async function initMIDI() {
            if (!navigator.requestMIDIAccess) return alert("Browser not supported.");
            try {
                const midiAccess = await navigator.requestMIDIAccess();
                initBtn.innerText = "MIDI Active";
                initBtn.style.backgroundColor = "#bdc3c7";
                initBtn.disabled = true;

                const savedDeviceId = loadSettings();

                const updateInputs = () => {
                    const inputs = midiAccess.inputs.values();
                    midiSelect.innerHTML = '<option value="">-- Choose Device --</option>';
                    for (let input of inputs) {
                        const opt = document.createElement('option');
                        opt.value = input.id;
                        opt.text = input.name;
                        if (input.id === savedDeviceId) opt.selected = true;
                        midiSelect.add(opt);
                    }
                    // Auto-connect if device matches saved ID
                    if (midiSelect.value) midiSelect.onchange();
                };

                midiAccess.onstatechange = updateInputs;
                updateInputs();

                midiSelect.onchange = () => {
                    if (currentInput) currentInput.onmidimessage = null;
                    currentInput = midiAccess.inputs.get(midiSelect.value);
                    if (currentInput) {
                        currentInput.onmidimessage = handleMidiMessage;
                        display.innerText = "Ready!";
                        saveSettings();
                    }
                };
            } catch (err) { console.error(err); }
        }

        // Listeners
        initBtn.addEventListener('click', initMIDI);
        transposeSelect.addEventListener('change', updateStatusText);
        bgColorInput.addEventListener('input', () => { applyColors(); saveSettings(); });
        fgColorInput.addEventListener('input', () => { applyColors(); saveSettings(); });

        // Init
        initTransposeOptions();
        loadSettings();
        buildKeyboard();
    </script>
</body>
</html>
